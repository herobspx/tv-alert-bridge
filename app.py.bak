import os
from fastapi import FastAPI, Request, HTTPException
from pydantic import BaseModel
import requests

BOT_TOKEN    = os.environ.get("BOT_TOKEN", "")
CHAT_ID      = os.environ.get("CHAT_ID", "")
ALERT_SECRET = os.environ.get("ALERT_SECRET", "ai-candle-123")

app = FastAPI()

def tg_send(chat_id: str, text: str) -> bool:
    if not BOT_TOKEN or not chat_id or not text:
        return False
    url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
    payload = {"chat_id": chat_id, "text": text}
    try:
        r = requests.post(url, json=payload, timeout=10)
        return r.status_code == 200
    except Exception:
        return False

@app.get("/health")
def health():
    return {"status": "ok"}

class SendReq(BaseModel):
    text: str

@app.post("/send")
async def send(req: SendReq):
    ok = tg_send(CHAT_ID, req.text)
    if not ok:
        raise HTTPException(status_code=500, detail="telegram send failed")
    return {"ok": True}

@app.post("/webhook")
async def webhook(request: Request):
    # 1) Ø¬Ø±Ù‘Ø¨ Ù†Ù‚Ø±Ø£ Ø§Ù„Ø³Ø± Ù…Ù† Ø§Ù„Ù‡ÙŠØ¯Ø±
    secret_hdr = request.headers.get("X-Alert-Secret")
    # 2) ÙˆÙ†Ù‚Ø±Ø£ Ø§Ù„Ø¨ÙˆØ¯ÙŠ (JSON)
    body = await request.json()
    secret_json = None
    if isinstance(body, dict):
        secret_json = body.get("secret")

    secret = secret_hdr or secret_json
    if not secret or secret != ALERT_SECRET:
        raise HTTPException(status_code=400, detail="invalid secret")

    # Ø¨ÙŠØ§Ù†Ø§Øª TradingView Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©
    symbol    = (body.get("symbol") or "").strip()
    side_raw  = (body.get("side")   or "").strip()
    price     = str(body.get("price") or "")
    tf        = str(body.get("timeframe") or "")
    note      = (body.get("text")   or "").strip()

    # ØªØ·Ø¨ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø§Ø±Ø© (Call/Put) + Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
    s = side_raw.lower()
    if s.startswith("put") or s.startswith("sell"):
        side = "PUT ğŸ”´"
    elif s.startswith("call") or s.startswith("buy"):
        side = "Call ğŸŸ¢"
    else:
        side = side_raw

    msg = (
        f"ğŸ“Š {symbol}\n"
        f"Ø¥Ø´Ø§Ø±Ø© : {side}\n"
        f"ğŸ’µ Ø§Ù„Ø³Ø¹Ø±: {price}\n"
        f"ğŸ•’ Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ: {tf}\n"
        f"âš ï¸ Ø¬Ù…ÙŠØ¹ Ù…Ø§ ÙŠÙØ·Ø±Ø­ Ù„Ø§ ÙŠÙØ¹Ø¯Ù‘ ØªÙˆØµÙŠØ©."
    )
    if note:
        msg += f"\nğŸ“ {note}"

    ok = tg_send(CHAT_ID, msg)
    if not ok:
        raise HTTPException(status_code=500, detail="telegram send failed")

    return {"ok": True}
